---
- name: Virtualization  ----  Vagrant
  block:

    # - name: Virtualization  ----  Vagrant ---- Download and convert HashiCorp GPG key
    #   ansible.builtin.shell: |
    #     curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /etc/apt/keyrings/hashicorp-archive-keyring.gpg
    #     chmod 0644 /etc/apt/keyrings/hashicorp-archive-keyring.gpg
    #   args:
    #     creates: /etc/apt/keyrings/hashicorp-archive-keyring.gpg
    #   register: gpg_download_result
    #   until: gpg_download_result is succeeded
    #   retries: 3
    #   delay: 5

    - name: Virtualization  ----  Vagrant ---- Download HashiCorp GPG key
      ansible.builtin.get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /tmp/hashicorp-archive-keyring.gpg.asc
        mode: '0644'

    - name: Virtualization  ----  Vagrant ---- Convert GPG key to binary format
      ansible.builtin.shell: |
        gpg --dearmor -o /etc/apt/keyrings/hashicorp-archive-keyring.gpg < /tmp/hashicorp-archive-keyring.gpg.asc
      args:
        executable: /bin/bash
        creates: /etc/apt/keyrings/hashicorp-archive-keyring.gpg

    - name: Virtualization  ----  Vagrant ---- Set keyring file permissions
      ansible.builtin.file:
        path: /etc/apt/keyrings/hashicorp-archive-keyring.gpg
        mode: '0644'

    - name: Virtualization  ----  Vagrant ---- Add apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ codename }} main"
        filename: hashicorp
        state: present
      vars:
        ## HashiCorp supports only LTS releases
        ## So 25.04 (plucky) and 25.10 (questing) are mapped to 24.04 LTS (noble)
        codename: >-
          {% if ansible_distribution_version.startswith('25.') -%}
          noble{%- else -%}
          {{ ansible_distribution_release }}{%- endif %}

    - name: Virtualization  ----  Vagrant ---- Install Vagrant packages
      ansible.builtin.apt:
        pkg:
          - vagrant
        state: latest
        update_cache: true

    - name: Virtualization  ----  Vagrant ---- Install Vagrant plugins
      ansible.builtin.shell: |
        vagrant plugin install vagrant-cachier
        # vagrant plugin install vagrant-vbguest
        # vagrant plugin install vagrant-docker-compose
      become: true
      become_user: "{{ ansible_user }}"
      args:
        executable: /bin/bash

    - name: Virtualization  ----  Vagrant ---- Verify installation
      ansible.builtin.command: vagrant --version
      register: virtualization_vagrant_version_output
      changed_when: false

    - name: Virtualization  ----  Vagrant ---- Print version
      ansible.builtin.debug:
        msg: "{{ virtualization_vagrant_version_output.stdout }}"
